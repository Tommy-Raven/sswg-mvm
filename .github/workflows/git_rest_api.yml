# =====================================================================
# SSWGâ€“MVM API CI Pipeline
# File: .github/workflows/add_git_rest_api.yml
# Description:
#   Validates, lints, and tests API/ + generator/ modules.
#   Designed for SSWGâ€“MVM v0.9.mvm.25 governance rules.
#
# Author: Tommy Raven / Raven Recordings, LLC Â©2025
# =====================================================================

name: "ğŸ§© SSWGâ€“MVM: Build & Test API"

# ---------------------------------------------------------------------
# EVENT TRIGGERS
# ---------------------------------------------------------------------
on:
  push:
    branches: ["main", "dev", "canonical"]
    paths:
      - "API/**"
      - "generator/**"
      - "ai_core/**"
      - "ai_validation/**"
      - ".github/workflows/add_git_rest_api.yml"
  pull_request:
    branches: ["main", "canonical"]
    paths:
      - "API/**"
      - "generator/**"
      - "ai_core/**"
      - "ai_validation/**"
  workflow_dispatch:

# ---------------------------------------------------------------------
# PERMISSIONS
# ---------------------------------------------------------------------
permissions:
  contents: read       # API CI does not write to repo
  checks: write
  actions: read

# ---------------------------------------------------------------------
# JOB 1 â€” Build & Lint
# ---------------------------------------------------------------------
jobs:
  build_api:
    name: ğŸ”§ Build & Lint API
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      # ---------------------------
      # Python setup
      # ---------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; then
            pip install -r build/REQUIREMENTS.txt
          fi
          pip install flake8 pytest

      # ---------------------------
      # Linting
      # ---------------------------
      - name: ğŸ” Run flake8 (API + generator)
        run: |
          echo "Running flake8 linting..."
          flake8 API generator --max-line-length=120 --statistics

  # -------------------------------------------------------------------
  # JOB 2 â€” Unit Tests
  # -------------------------------------------------------------------
  test_api:
    name: ğŸ§ª Test API Modules
    needs: build_api
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; then
            pip install -r build/REQUIREMENTS.txt
          fi
          pip install flake8 pytest

      # ---------------------------
      # Run tests
      # ---------------------------
      - name: ğŸ§ª Execute Unit Tests
        run: |
          echo "Running pytest..."
          pytest -q API/tests generator/tests \
            --maxfail=1 --disable-warnings --tb=short

      # ---------------------------
      # Upload test artifacts
      # ---------------------------
      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b
        with:
          name: api-test-results
          path: .

  # -------------------------------------------------------------------
  # JOB 3 â€” Success Notification
  # -------------------------------------------------------------------
  notify_results:
    name: ğŸ”” Notify Success
    needs: test_api
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ’¬ Post Summary
        run: |
          echo "ğŸ‰ SSWGâ€“MVM API pipeline completed successfully!"
          echo "API + generator modules linted and tested."
          echo "Version: v0.9.mvm.25"
