# =====================================================================
# sswg-mvm API CI Pipeline
# File: .github/workflows/add_git_rest_api.yml
# Description:
#   Validates, lints, and tests API/ + generator/ modules.
#   Designed for sswg-mvm v0.9.mvm.25 governance rules.
#
# Author: Tommy Raven / Raven Recordings, LLC ¬©2025
# =====================================================================

name: "üß© sswg-mvm: Build & Test API"

# ---------------------------------------------------------------------
# EVENT TRIGGERS
# ---------------------------------------------------------------------
on:
  push:
    branches: ["main", "dev", "canonical"]
    paths:
      - "API/**"
      - "generator/**"
      - "ai_core/**"
      - "ai_validation/**"
      - ".github/workflows/add_git_rest_api.yml"
  pull_request:
    branches: ["main", "canonical"]
    paths:
      - "API/**"
      - "generator/**"
      - "ai_core/**"
      - "ai_validation/**"
  workflow_dispatch:

# ---------------------------------------------------------------------
# PERMISSIONS
# ---------------------------------------------------------------------
permissions:
  contents: read       # API CI does not write to repo
  checks: write
  actions: read

# ---------------------------------------------------------------------
# JOB 1 ‚Äî Build & Lint
# ---------------------------------------------------------------------
jobs:
  build_api:
    name: üîß Build & Lint API
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      # ---------------------------
      # Python setup
      # ---------------------------
      - name: üì¶ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; 
            then
              pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; 
            then
              pip install -r REQUIREMENTS.txt
          fi
          pip install fastapi uvicorn flake8 pytest httpx pytest rich black json

      # ---------------------------
      # Linting
      # ---------------------------
      - name: üîç Run flake8 (API + generator)
        run: |
          echo "Running flake8 linting..."
          flake8 API generator --max-line-length=120 --statistics

  # -------------------------------------------------------------------
  # JOB 2 ‚Äî Unit Tests
  # -------------------------------------------------------------------
  test_api:
    name: üß™ Test API Modules
    needs: build_api
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: üì¶ Install dependencies
        run: |
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; then
            pip install -r build/REQUIREMENTS.txt
          fi
          pip install flake8 pytest

      # ---------------------------
      # Run tests
      # ---------------------------
      - name: üß™ Execute Unit Tests
        run: |
          echo "Running pytest..."
          pytest -q API/tests generator/tests \
            --maxfail=1 --disable-warnings --tb=short

      # ---------------------------
      # Upload test artifacts
      # ---------------------------
      - name: üìä Upload Test Results
        if: always()
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b
        with:
          name: api-test-results
          path: .

  # -------------------------------------------------------------------
  # JOB 3 ‚Äî Success Notification
  # -------------------------------------------------------------------
  notify_results:
    name: üîî Notify Success
    needs: test_api
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: üí¨ Post Summary
        run: |
          echo "üéâ sswg-mvm API pipeline completed successfully!"
          echo "API + generator modules linted and tested."
          echo "Version: v0.9.mvm.25"
