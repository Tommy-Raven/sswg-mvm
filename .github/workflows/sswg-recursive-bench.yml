name: SSWG-MVM Recursive Benchmarks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # runs nightly at 3AM UTC

jobs:
  recursive-bench:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run deep recursion benchmarks
        run: |
          mkdir -p benchmark_results
          python3 - << 'EOF'
from pathlib import Path
import json
from generator.main import run_mvm

templates = Path("data/templates").glob("*.json")
cycles = 10

results = {}

for tmpl in templates:
    wf = json.loads(tmpl.read_text())
    name = tmpl.stem
    print(f"\n[Benchmark] Starting recursive cycles for {name}\n")

    cycle_data = []
    current_path = tmpl

    for i in range(1, cycles+1):
        refined = run_mvm(current_path, preview=False, enable_history=True)
        out = {
            "cycle": i,
            "workflow_id": refined.get("workflow_id"),
            "evaluation": refined.get("evaluation", {}),
            "modules": len(refined.get("modules", [])),
        }
        cycle_data.append(out)

        # Save intermediate workflow
        inter_path = Path(f"benchmark_results/{name}_cycle_{i}.json")
        inter_path.write_text(json.dumps(refined, indent=2))
        current_path = inter_path

    results[name] = cycle_data

# Save summary
Path("benchmark_results/summary.json").write_text(
    json.dumps(results, indent=2)
)
EOF

      - name: Upload Recursive Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: sswg-recursive-benchmark
          path: benchmark_results/
